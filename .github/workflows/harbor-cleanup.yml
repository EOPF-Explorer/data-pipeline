name: Harbor Registry Cleanup

on:
#   schedule:
#     # Run daily at 2:00 AM UTC
#     - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual deletions)'
        required: false
        default: true
        type: boolean

env:
  HARBOR_URL: ${{ secrets.OVH_HARBOR_REGISTRY }}
  HARBOR_USERNAME: ${{ secrets.OVH_HARBOR_USERNAME }}
  HARBOR_PASSWORD: ${{ secrets.OVH_HARBOR_PASSWORD }}
  PROJECT_NAME: eopf-sentinel-zarr-explorer
  REPOSITORY_NAME: data-pipeline
  # Retention periods in days
  SHA_RETENTION_DAYS: 0 #7
  PR_RETENTION_DAYS: 1 #90

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests python-dateutil

      - name: Run cleanup script
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          python3 << 'EOF'
          import os
          import re
          import requests
          from datetime import datetime, timedelta, timezone
          from dateutil import parser as date_parser

          # Configuration
          HARBOR_URL = os.environ['HARBOR_URL'].rstrip('/')
          HARBOR_USERNAME = os.environ['HARBOR_USERNAME']
          HARBOR_PASSWORD = os.environ['HARBOR_PASSWORD']
          PROJECT_NAME = os.environ['PROJECT_NAME']
          REPOSITORY_NAME = os.environ['REPOSITORY_NAME']
          SHA_RETENTION_DAYS = int(os.environ['SHA_RETENTION_DAYS'])
          PR_RETENTION_DAYS = int(os.environ['PR_RETENTION_DAYS'])
          DRY_RUN = os.environ.get('DRY_RUN', 'true').lower() == 'true'

          # Tag patterns
          SHA_PATTERN = re.compile(r'^sha-[a-f0-9]+$')
          PR_PATTERN = re.compile(r'^pr-\d+$')
          VERSION_PATTERN = re.compile(r'^v?\d+\.\d+(\.\d+)?(-.*)?$|^latest$|^main$')

          def get_api_url(path):
              """Construct full API URL."""
              # Handle both with and without https://
              base = HARBOR_URL
              if not base.startswith('http'):
                  base = f'https://{base}'
              return f'{base}/api/v2.0{path}'

          def get_artifacts():
              """Fetch all artifacts from the repository."""
              url = get_api_url(f'/projects/{PROJECT_NAME}/repositories/{REPOSITORY_NAME}/artifacts')
              params = {'page_size': 100, 'with_tag': 'true'}

              all_artifacts = []
              page = 1

              while True:
                  params['page'] = page
                  response = requests.get(
                      url,
                      params=params,
                      auth=(HARBOR_USERNAME, HARBOR_PASSWORD),
                      timeout=30
                  )
                  response.raise_for_status()

                  artifacts = response.json()
                  if not artifacts:
                      break

                  all_artifacts.extend(artifacts)
                  page += 1

              return all_artifacts

          def delete_artifact(digest):
              """Delete an artifact by its digest."""
              url = get_api_url(f'/projects/{PROJECT_NAME}/repositories/{REPOSITORY_NAME}/artifacts/{digest}')
              response = requests.delete(
                  url,
                  auth=(HARBOR_USERNAME, HARBOR_PASSWORD),
                  timeout=30
              )
              response.raise_for_status()

          def delete_tag(reference, tag_name):
              """Delete a specific tag from an artifact."""
              url = get_api_url(f'/projects/{PROJECT_NAME}/repositories/{REPOSITORY_NAME}/artifacts/{reference}/tags/{tag_name}')
              response = requests.delete(
                  url,
                  auth=(HARBOR_USERNAME, HARBOR_PASSWORD),
                  timeout=30
              )
              response.raise_for_status()

          def should_delete_tag(tag_name, push_time):
              """Determine if a tag should be deleted based on retention policy."""
              now = datetime.now(timezone.utc)

              # Parse push time
              if isinstance(push_time, str):
                  pushed_at = date_parser.parse(push_time)
              else:
                  pushed_at = push_time

              # Ensure timezone aware
              if pushed_at.tzinfo is None:
                  pushed_at = pushed_at.replace(tzinfo=timezone.utc)

              age_days = (now - pushed_at).days

              # Version tags (semver, latest, main) - NEVER delete
              if VERSION_PATTERN.match(tag_name):
                  return False, "version tag (protected)"

              # SHA tags - delete after SHA_RETENTION_DAYS
              if SHA_PATTERN.match(tag_name):
                  if age_days > SHA_RETENTION_DAYS:
                      return True, f"SHA tag older than {SHA_RETENTION_DAYS} days ({age_days} days old)"
                  return False, f"SHA tag within retention ({age_days} days old)"

              # PR tags - delete after PR_RETENTION_DAYS
              if PR_PATTERN.match(tag_name):
                  if age_days > PR_RETENTION_DAYS:
                      return True, f"PR tag older than {PR_RETENTION_DAYS} days ({age_days} days old)"
                  return False, f"PR tag within retention ({age_days} days old)"

              # Unknown tag patterns - keep them (safe default)
              return False, "unknown pattern (keeping as precaution)"

          def main():
              print("=" * 60)
              print("Harbor Registry Cleanup")
              print("=" * 60)
              print(f"Harbor URL: {HARBOR_URL}")
              print(f"Project: {PROJECT_NAME}")
              print(f"Repository: {REPOSITORY_NAME}")
              print(f"SHA retention: {SHA_RETENTION_DAYS} days")
              print(f"PR retention: {PR_RETENTION_DAYS} days")
              print(f"Dry run: {DRY_RUN}")
              print("=" * 60)

              try:
                  artifacts = get_artifacts()
                  print(f"\nFound {len(artifacts)} artifact(s)\n")
              except requests.exceptions.RequestException as e:
                  print(f"Error fetching artifacts: {e}")
                  return 1

              tags_to_delete = []
              tags_to_keep = []
              artifacts_to_check_deletion = []

              for artifact in artifacts:
                  digest = artifact.get('digest', 'unknown')
                  push_time = artifact.get('push_time')
                  tags = artifact.get('tags') or []

                  print(f"\nArtifact: {digest[:20]}...")
                  print(f"  Push time: {push_time}")
                  print(f"  Tags: {[t.get('name') for t in tags]}")

                  artifact_tags_to_delete = []
                  artifact_tags_to_keep = []

                  for tag in tags:
                      tag_name = tag.get('name')
                      tag_push_time = tag.get('push_time') or push_time

                      delete, reason = should_delete_tag(tag_name, tag_push_time)

                      if delete:
                          print(f"    âŒ {tag_name}: DELETE - {reason}")
                          artifact_tags_to_delete.append(tag_name)
                          tags_to_delete.append((digest, tag_name))
                      else:
                          print(f"    âœ… {tag_name}: KEEP - {reason}")
                          artifact_tags_to_keep.append(tag_name)
                          tags_to_keep.append(tag_name)

                  # If all tags are to be deleted, mark artifact for potential deletion
                  if artifact_tags_to_delete and not artifact_tags_to_keep:
                      artifacts_to_check_deletion.append(digest)

              print("\n" + "=" * 60)
              print("SUMMARY")
              print("=" * 60)
              print(f"Tags to delete: {len(tags_to_delete)}")
              print(f"Tags to keep: {len(tags_to_keep)}")
              print(f"Artifacts that may become untagged: {len(artifacts_to_check_deletion)}")

              if not tags_to_delete:
                  print("\nNo tags to delete. Exiting.")
                  return 0

              if DRY_RUN:
                  print("\nðŸ” DRY RUN MODE - No changes made")
                  print("\nTags that would be deleted:")
                  for digest, tag_name in tags_to_delete:
                      print(f"  - {tag_name} (artifact: {digest[:20]}...)")
                  return 0

              # Perform deletions
              print("\nðŸ—‘ï¸  PERFORMING DELETIONS...")
              deleted_count = 0
              error_count = 0

              for digest, tag_name in tags_to_delete:
                  try:
                      print(f"  Deleting tag: {tag_name}...", end=" ")
                      delete_tag(digest, tag_name)
                      print("âœ“")
                      deleted_count += 1
                  except requests.exceptions.RequestException as e:
                      print(f"âœ— Error: {e}")
                      error_count += 1

              print("\n" + "=" * 60)
              print(f"Deleted: {deleted_count} tags")
              print(f"Errors: {error_count}")
              print("=" * 60)

              # Note: Untagged artifacts can be cleaned up by Harbor's garbage collection
              if artifacts_to_check_deletion:
                  print("\nâš ï¸  Some artifacts are now untagged.")
                  print("Run Harbor garbage collection to reclaim storage space.")

              return 0 if error_count == 0 else 1

          if __name__ == '__main__':
              exit(main())
          EOF

      - name: Summary
        run: |
          echo "### Harbor Cleanup Complete ðŸ§¹" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuration:**" >> $GITHUB_STEP_SUMMARY
          echo "- SHA tags retention: ${{ env.SHA_RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "- PR tags retention: ${{ env.PR_RETENTION_DAYS }} days" >> $GITHUB_STEP_SUMMARY
          echo "- Version tags: Protected (never deleted)" >> $GITHUB_STEP_SUMMARY
