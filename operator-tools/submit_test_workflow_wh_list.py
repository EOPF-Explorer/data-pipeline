#!/usr/bin/env python3
import json
import time

import requests

# List of products to process (from S3 listing)
products = [
    "S2A_MSIL2A_20210917T115221_N0500_R123_T28RBS_20230110T165456",
    "S2A_MSIL2A_20210920T120331_N0500_R023_T28RBS_20230108T205311",
    "S2A_MSIL2A_20210927T115221_N0500_R123_T28RBS_20230112T171055",
    "S2A_MSIL2A_20210930T120331_N0500_R023_T28RBS_20230109T180123",
    "S2A_MSIL2A_20211007T115221_N0500_R123_T28RBS_20230102T185542",
    "S2A_MSIL2A_20211010T120331_N0500_R023_T28RBS_20230106T001906",
    "S2A_MSIL2A_20211017T115221_N0500_R123_T28RBS_20230104T081202",
    "S2A_MSIL2A_20211020T120331_N0500_R023_T28RBS_20230105T095115",
    "S2A_MSIL2A_20211027T115221_N0500_R123_T28RBS_20230105T031019",
    "S2A_MSIL2A_20211030T120331_N0500_R023_T28RBS_20230105T031900",
    "S2A_MSIL2A_20211106T115221_N0500_R123_T28RBS_20221229T073629",
    "S2A_MSIL2A_20211109T120331_N0500_R023_T28RBS_20221229T073655",
    "S2A_MSIL2A_20211116T115221_N0500_R123_T28RBS_20221230T200900",
    "S2A_MSIL2A_20211119T120321_N0500_R023_T28RBS_20221229T191326",
    "S2A_MSIL2A_20211126T115221_N0500_R123_T28RBS_20230102T132307",
    "S2A_MSIL2A_20211129T120321_N0500_R023_T28RBS_20221230T041345",
    "S2A_MSIL2A_20211206T115221_N0500_R123_T28RBS_20221224T140610",
    "S2A_MSIL2A_20211209T120321_N0500_R023_T28RBS_20221225T010957",
    "S2A_MSIL2A_20211216T115221_N0500_R123_T28RBS_20221224T043535",
    "S2A_MSIL2A_20211219T120321_N0500_R023_T28RBS_20221224T151838",
    "S2A_MSIL2A_20211226T115221_N0500_R123_T28RBS_20221224T161518",
    "S2A_MSIL2A_20211229T120331_N0500_R023_T28RBS_20221227T100257",
    "S2B_MSIL2A_20210922T115219_N0500_R123_T28RBS_20230113T174254",
    "S2B_MSIL2A_20210925T120319_N0500_R023_T28RBS_20230109T005655",
    "S2B_MSIL2A_20211002T115219_N0500_R123_T28RBS_20230102T210850",
    "S2B_MSIL2A_20211005T120329_N0500_R023_T28RBS_20230105T092944",
    "S2B_MSIL2A_20211012T115219_N0500_R123_T28RBS_20230103T222101",
    "S2B_MSIL2A_20211015T120329_N0500_R023_T28RBS_20230104T221431",
    "S2B_MSIL2A_20211022T115219_N0500_R123_T28RBS_20230104T151158",
    "S2B_MSIL2A_20211025T120329_N0500_R023_T28RBS_20230105T094555",
    "S2B_MSIL2A_20211101T115219_N0500_R123_T28RBS_20221228T204555",
    "S2B_MSIL2A_20211104T120329_N0500_R023_T28RBS_20221230T183447",
    "S2B_MSIL2A_20211111T115219_N0500_R123_T28RBS_20221229T220152",
    "S2B_MSIL2A_20211114T120319_N0500_R023_T28RBS_20221229T121936",
    "S2B_MSIL2A_20211121T115219_N0500_R123_T28RBS_20221231T033626",
    "S2B_MSIL2A_20211124T120319_N0500_R023_T28RBS_20221229T221129",
    "S2B_MSIL2A_20211201T115219_N0500_R123_T28RBS_20221224T083520",
    "S2B_MSIL2A_20211204T120319_N0500_R023_T28RBS_20221222T175403",
    "S2B_MSIL2A_20211211T115209_N0500_R123_T28RBS_20221225T033159",
    "S2B_MSIL2A_20211214T120319_N0500_R023_T28RBS_20221226T065701",
    "S2B_MSIL2A_20211221T115219_N0500_R123_T28RBS_20221224T053435",
    "S2B_MSIL2A_20211224T120319_N0500_R023_T28RBS_20221227T125536",
    "S2B_MSIL2A_20211231T115219_N0500_R123_T28RBS_20221226T114305",
    "S2B_MSIL2A_20220103T120319_N0510_R023_T28RBS_20240423T015628",
]

# Process each product
for i, product in enumerate(products, 1):
    # Test STAC item submission
    payload = {
        "source_url": f"https://s3.explorer.eopf.copernicus.eu/esa-zarr-sentinel-explorer-fra/cpm-manual/{product}.json",
        "collection": "sentinel-2-l2a",
        "action": "convert-v1-s2-hp",  # specify the action to use the S2 high-priority trigger
    }

    message = json.dumps(payload)

    # Submit via HTTP webhook endpoint
    try:
        response = requests.post(
            "http://localhost:12000/samples",
            data=message,
            headers={"Content-Type": "application/json"},
        )

        print(f"[{i}/{len(products)}] ✅ Published workflow for item: {product}")
        print(f"Response status: {response.status_code}")

        if response.status_code != 200:
            print(f"Warning: Non-200 response for {product}: {response.text}")

    except Exception as e:
        print(f"[{i}/{len(products)}] ❌ Error processing {product}: {str(e)}")

    # Add small delay to avoid overwhelming the server
    if i < len(products):
        time.sleep(1)

print(f"\n✅ Completed processing {len(products)} products.")
