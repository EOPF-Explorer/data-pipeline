---
# Generic AMQP publish job
# Publishes payload from 'amqp-payload' configmap to RabbitMQ
#
# Usage:
#   1. Create configmap: kubectl create configmap amqp-payload --from-file=body.json=<payload-file>
#   2. Apply this job: kubectl apply -f amqp-publish-once.yaml
#   3. Wait: kubectl wait --for=condition=complete job/amqp-publish-once
#
apiVersion: batch/v1
kind: Job
metadata:
  name: amqp-publish-once
  namespace: devseed-staging
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: publish
          image: ghcr.io/eopf-explorer/data-pipeline:v26
          command:
            - python
            - /app/scripts/publish_amqp.py
          args:
            - --host
            - rabbitmq.core.svc.cluster.local
            - --port
            - "5672"
            - --user
            - $(RABBITMQ_USERNAME)
            - --password
            - $(RABBITMQ_PASSWORD)
            - --exchange
            - eopf_items
            - --routing-key-template
            - eopf.item.found.{collection}
            - --payload-file
            - /payload/body.json
          env:
            - name: RABBITMQ_USERNAME
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-credentials
                  key: username
            - name: RABBITMQ_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: rabbitmq-credentials
                  key: password
          volumeMounts:
            - name: payload
              mountPath: /payload
              readOnly: true
      volumes:
        - name: payload
          configMap:
            name: amqp-payload
